<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Gaylen Fronk">

<title>Analysis Workflow Step 4: Select &amp; fit final model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="04_fit_select_final_model_files/libs/clipboard/clipboard.min.js"></script>
<script src="04_fit_select_final_model_files/libs/quarto-html/quarto.js"></script>
<script src="04_fit_select_final_model_files/libs/quarto-html/popper.min.js"></script>
<script src="04_fit_select_final_model_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="04_fit_select_final_model_files/libs/quarto-html/anchor.min.js"></script>
<link href="04_fit_select_final_model_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="04_fit_select_final_model_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="04_fit_select_final_model_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="04_fit_select_final_model_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="04_fit_select_final_model_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Analysis Workflow Step 4: Select &amp; fit final model</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Gaylen Fronk </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>Load libraries</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Source functions file</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"fun_moodivate.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This functions file (fun_moodivate.R) contains many functions that are used throughout the Moodivate project analysis scripts. Functions split data, fit and evaluate models, and provide helper functionality for the modeling process. See all code building functions within fun_moodivate.R.</p>
</section>
<section id="read-in-data" class="level2">
<h2 class="anchored" data-anchor-id="read-in-data">Read in data</h2>
<p>To ensure all proposed analyses are feasible and to specify analysis steps as precisely as possible, <strong>we continue to conduct our proposed analyses using a shuffled (i.e., randomized) version of our dataset</strong>. Following testing, our analyses will follow these scripts exactly using our real data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"~/Desktop/internship/moodivate/toy_data.csv"</span>, </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 342
Columns: 43
$ record_id               &lt;dbl&gt; 3, 4, 13, 16, 19, 25, 55, 58, 68, 74, 75, 77, …
$ session_count_w1        &lt;dbl&gt; 26, 1, 5, 1, 13, 10, 2, 36, 4, 15, 11, 18, 12,…
$ session_count_w2        &lt;dbl&gt; 41, 0, 3, 6, 13, 5, 1, 14, 0, 16, 4, 7, 8, 7, …
$ session_count_w3        &lt;dbl&gt; 31, 0, 4, 12, 10, 8, 1, 16, 2, 11, 0, 9, 5, 3,…
$ session_count_w4        &lt;dbl&gt; 23, 0, 1, 9, 18, 5, 0, 15, 0, 10, 0, 4, 0, 3, …
$ total_time_w1           &lt;dbl&gt; 8025, 763, 1388, 364, 2957, 1849, 221, 4456, 8…
$ total_time_w2           &lt;dbl&gt; 7254, 0, 394, 1055, 1628, 328, 58, 929, 0, 121…
$ total_time_w3           &lt;dbl&gt; 2894, 0, 310, 928, 1107, 801, 237, 1496, 158, …
$ total_time_w4           &lt;dbl&gt; 3822, 0, 95, 713, 1793, 552, 0, 1296, 0, 1235,…
$ average_session_time_w1 &lt;dbl&gt; 309, 763, 278, 364, 227, 185, 111, 124, 202, 1…
$ average_session_time_w2 &lt;dbl&gt; 177, 0, 131, 176, 125, 66, 58, 66, 0, 76, 99, …
$ average_session_time_w3 &lt;dbl&gt; 93, 0, 78, 77, 111, 100, 237, 94, 79, 76, 0, 4…
$ average_session_time_w4 &lt;dbl&gt; 166, 0, 95, 79, 100, 110, 0, 86, 0, 124, 0, 52…
$ add_activity_w1         &lt;dbl&gt; 2, 1, 1, 1, 0, 2, 1, 14, 1, 1, 5, 4, 1, 2, 1, …
$ add_activity_w2         &lt;dbl&gt; 4, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 2…
$ add_activity_w3         &lt;dbl&gt; 2, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1…
$ add_activity_w4         &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 1, 2…
$ scheduled_activities_w1 &lt;dbl&gt; 165, 1, 3, 18, 7, 26, 7, 70, 1, 87, 21, 48, 10…
$ scheduled_activities_w2 &lt;dbl&gt; 155, 0, 1, 20, 5, 25, 7, 53, 0, 84, 15, 49, 4,…
$ scheduled_activities_w3 &lt;dbl&gt; 152, 0, 2, 17, 3, 25, 7, 59, 0, 82, 0, 48, 5, …
$ scheduled_activities_w4 &lt;dbl&gt; 148, 0, 0, 17, 6, 25, 0, 58, 0, 82, 0, 48, 0, …
$ completed_activities_w1 &lt;dbl&gt; 76, 0, 2, 0, 3, 10, 0, 12, 0, 0, 20, 15, 6, 1,…
$ completed_activities_w2 &lt;dbl&gt; 129, 0, 0, 1, 2, 11, 0, 0, 0, 0, 1, 15, 0, 0, …
$ completed_activities_w3 &lt;dbl&gt; 114, 0, 2, 6, 3, 21, 0, 4, 0, 0, 0, 6, 5, 0, 2…
$ completed_activities_w4 &lt;dbl&gt; 82, 0, 0, 3, 5, 11, 0, 3, 0, 1, 0, 8, 0, 0, 0,…
$ add_goal_w1             &lt;dbl&gt; 6, 1, 2, 1, 2, 3, 1, 6, 1, 1, 2, 5, 7, 3, 4, 1…
$ add_goal_w2             &lt;dbl&gt; 3, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 2…
$ add_goal_w3             &lt;dbl&gt; 1, 0, 1, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0…
$ add_goal_w4             &lt;dbl&gt; 0, 0, 0, 0, 1, 0, 0, 3, 0, 0, 0, 0, 0, 0, 1, 3…
$ badges_earned_w1        &lt;dbl&gt; 7, 2, 4, 1, 4, 6, 1, 8, 4, 5, 6, 10, 8, 6, 6, …
$ badges_earned_w2        &lt;dbl&gt; 7, 0, 1, 4, 2, 2, 0, 2, 0, 3, 2, 7, 2, 0, 0, 6…
$ badges_earned_w3        &lt;dbl&gt; 4, 0, 2, 3, 2, 3, 1, 3, 0, 4, 0, 2, 4, 2, 0, 4…
$ badges_earned_w4        &lt;dbl&gt; 4, 0, 0, 4, 2, 4, 0, 3, 0, 4, 0, 1, 0, 2, 4, 5…
$ mood_days_wk1           &lt;dbl&gt; 5, 1, 3, 0, 5, 4, 0, 5, 1, 7, 2, 6, 5, 3, 6, 6…
$ mood_days_wk2           &lt;dbl&gt; 6, 0, 3, 3, 3, 4, 0, 5, 0, 6, 1, 3, 6, 2, 3, 7…
$ mood_days_wk3           &lt;dbl&gt; 6, 0, 2, 2, 3, 4, 1, 6, 1, 7, 0, 3, 3, 2, 2, 7…
$ mood_days_wk4           &lt;dbl&gt; 6, 0, 1, 3, 6, 4, 0, 4, 0, 5, 0, 2, 0, 2, 5, 7…
$ phq8_comp_wk1           &lt;dbl&gt; 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ phq8_comp_wk2           &lt;dbl&gt; 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1…
$ phq8_comp_wk3           &lt;dbl&gt; 0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0, 0…
$ phq8_comp_wk4           &lt;dbl&gt; 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1…
$ bdi_baseline            &lt;dbl&gt; 29, 41, 35, 33, 37, 18, 11, 40, 13, 36, 42, 27…
$ bdi_outcome             &lt;dbl&gt; 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1…</code></pre>
</div>
</div>
</section>
<section id="prepare-data" class="level2">
<h2 class="anchored" data-anchor-id="prepare-data">Prepare data</h2>
<p>We prepare our data in the same way as all previous scripts.</p>
<section id="set-up-outcome-variable-levels" class="level3">
<h3 class="anchored" data-anchor-id="set-up-outcome-variable-levels">Set up outcome variable levels</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>y_col_name <span class="ot">&lt;-</span> <span class="st">"bdi_outcome"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>y_level_pos <span class="ot">&lt;-</span> <span class="st">"non_responder"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>y_level_neg <span class="ot">&lt;-</span> <span class="st">"responder"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="class-variables-set-factor-levels" class="level3">
<h3 class="anchored" data-anchor-id="class-variables-set-factor-levels">Class variables &amp; set factor levels</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rename outcome to y</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">y =</span> <span class="sc">!!</span>y_col_name) <span class="sc">|&gt;</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">case_when</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"non_responder"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"responder"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># y as a factor with two levels, positive level first</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">y =</span> <span class="fu">factor</span>(y, <span class="at">levels =</span> <span class="fu">c</span>(<span class="sc">!!</span>y_level_pos,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="sc">!!</span>y_level_neg))) <span class="sc">|&gt;</span> </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># standardize naming</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_replace</span>(.x, <span class="st">"_w1"</span>, <span class="st">"_wk1"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_replace</span>(.x, <span class="st">"_w2"</span>, <span class="st">"_wk2"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_replace</span>(.x, <span class="st">"_w3"</span>, <span class="st">"_wk3"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_replace</span>(.x, <span class="st">"_w4"</span>, <span class="st">"_wk4"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># move bdi_baseline to be first variable in dataset for penalty.factor</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(bdi_baseline) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="divide-data" class="level2">
<h2 class="anchored" data-anchor-id="divide-data">Divide data</h2>
<section id="set-cross-validation-parameters" class="level3">
<h3 class="anchored" data-anchor-id="set-cross-validation-parameters">Set cross-validation parameters</h3>
<p>Following nested cross-validation conducted in scripts 01-03, the final step is to fit and select models using the <em>inner loop CV</em> but in our <em>entire dataset</em>. Consequently, we use one repeat of 10-fold CV. Performance metrics from this round of CV will <strong>not</strong> be used for model evaluation; they will only be used for selecting a final model configuration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cv_resample_type <span class="ot">&lt;-</span> <span class="st">"kfold"</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>cv_resample <span class="ot">&lt;-</span> <span class="st">"1_x_10"</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>seed_splits <span class="ot">&lt;-</span> <span class="dv">111594</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-splits" class="level3">
<h3 class="anchored" data-anchor-id="make-splits">Make splits</h3>
<p>Divide data using <code>make_splits()</code> function (from fun_moodivate.R). We are stratifying by the outcome variable <code>y</code> to ensure equal distribution of outcome classes across all inner and outer folds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>splits <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_splits</span>(cv_resample_type, cv_resample, cv_outer_resample,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>              cv_inner_resample, <span class="at">the_seed =</span> seed_splits,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">strata =</span> <span class="st">"y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="set-up-model-configurations" class="level2">
<h2 class="anchored" data-anchor-id="set-up-model-configurations">Set up model configurations</h2>
<p>Possible model configurations are defined identically to previous scripts 01-03.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>algorithm <span class="ot">&lt;-</span> <span class="st">"glmnet"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>ml_mode <span class="ot">&lt;-</span> <span class="st">"classification"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># alpha (mixture)</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>hp1_glmnet <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">seq</span>(.<span class="dv">1</span>, <span class="dv">1</span>, <span class="at">length.out =</span> <span class="dv">10</span>)) </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># lambda (penalty)</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>hp2_glmnet_min <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">8</span> <span class="co"># min for penalty grid - will be passed into exp(seq(min, max, length.out = out))</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>hp2_glmnet_max <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># max for penalty grid</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>hp2_glmnet_out <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># length of penalty grid</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-configurations-tibble" class="level2">
<h2 class="anchored" data-anchor-id="make-configurations-tibble">Make configurations tibble</h2>
<p>This is a grid expansion of the splits, hyperparameters, and feature sets. Each row in the tibble will serve as a model configuration that can then be fit below. This tibble will also be used to connect results to model configurations.</p>
<section id="extract-cv-parameters-from-strings" class="level3">
<h3 class="anchored" data-anchor-id="extract-cv-parameters-from-strings">Extract CV parameters from strings</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>n_repeats <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(cv_resample,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"_x_</span><span class="sc">\\</span><span class="st">d{1,2}"</span>))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>n_folds <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(cv_resample,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">"</span><span class="sc">\\</span><span class="st">d{1,3}_x_"</span>))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>split_num <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span>(n_repeats <span class="sc">*</span> n_folds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="make-configurations-grid" class="level3">
<h3 class="anchored" data-anchor-id="make-configurations-grid">Make configurations grid</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>configs <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">split_num =</span> split_num,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">feature_set =</span> <span class="fu">c</span>(<span class="st">"thru_wk2"</span>, <span class="st">"thru_wk3"</span>, <span class="st">"thru_wk4"</span>),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">hp1 =</span> hp1_glmnet,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">hp2 =</span> <span class="cn">NA_integer_</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="st">"config_num"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">config_num =</span> <span class="fu">as.numeric</span>(config_num))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(configs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 330
Columns: 5
$ config_num  &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17,…
$ split_num   &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ feature_set &lt;chr&gt; "thru_wk2", "thru_wk2", "thru_wk2", "thru_wk2", "thru_wk2"…
$ hp1         &lt;dbl&gt; 0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 0.0…
$ hp2         &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…</code></pre>
</div>
</div>
<p>Feature sets are specific combinations of features. Here, we are fitting models separately that use data from weeks 1 &amp; 2, weeks 1 through 3, and weeks 1 through 4 so that we can examine the trade-off between model performance and duration of data collection required before making a decision.</p>
<p>Note that hp2 (lambda/penalty) is listed as NA because each configuration will <code>tune()</code> across the 100 values set using <code>hp2_glmnet_min</code>, <code>hp2_glmnet_max</code>, and <code>hp2_glmnet_out</code> (length).</p>
</section>
</section>
<section id="fit-models" class="level2">
<h2 class="anchored" data-anchor-id="fit-models">Fit models</h2>
<p>As in previous scripts, we set up a wrapper function to <code>map()</code> over every model configuration (i.e., every row in the configs tibble). For each model configuration, we:</p>
<ol type="1">
<li><p>Filter down to only that configuration’s row in the model configurations tibble.</p></li>
<li><p>Build a recipe using the custom <code>build_recipe()</code> function (in fun_moodivate.R).</p></li>
<li><p>Define a vector of penalty weights, which will apply equal penalty weighting to all variables except <code>bdi_baseline</code>, which will have a penalty weight of 0 and consequently will be included in all models.</p></li>
<li><p>Fit model, and get model performance metrics using our custom <code>tune_model()</code> from the fun_moodivate.R script. This function performs model tuning for the model configuration (defined by <code>feature_set</code>, <code>hp1</code>, and combination of inner and outer folds) across our range of values of <code>hp2</code>.</p></li>
<li><p>Append model performance metrics to the configs tibble in a new <code>results</code> tibble.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fit_eval <span class="ot">&lt;-</span> <span class="cf">function</span>(config_current, configs, d, splits) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter single config row from configs</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  config <span class="ot">&lt;-</span> configs <span class="sc">|&gt;</span> </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(config_num <span class="sc">==</span> config_current)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># build recipe</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  rec <span class="ot">&lt;-</span> <span class="fu">build_recipe</span>(<span class="at">d =</span> d, <span class="at">config =</span> config)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create penalty_weights vector using feature set dimensions</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  feat <span class="ot">&lt;-</span> rec <span class="sc">|&gt;</span> </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prep</span>(<span class="at">training =</span> d, <span class="at">strings_as_factors =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>) </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  penalty_weights <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">ncol</span>(feat) <span class="sc">-</span> <span class="dv">2</span>))</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(feat) </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fit model &amp; get predictions and model metrics</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">tune_model</span>(<span class="at">config =</span> config,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>                        <span class="at">rec =</span> rec, </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                        <span class="at">splits =</span> splits, </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>                        <span class="at">ml_mode =</span> ml_mode, </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cv_resample_type =</span> cv_resample_type,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                        <span class="at">hp2_glmnet_min =</span> hp2_glmnet_min, </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>                        <span class="at">hp2_glmnet_max =</span> hp2_glmnet_max, </span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>                        <span class="at">hp2_glmnet_out =</span> hp2_glmnet_out,</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>                        <span class="at">y_level_pos =</span> y_level_pos,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>                        <span class="at">penalty_weights =</span> penalty_weights)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="fit-models-across-all-configurations" class="level3">
<h3 class="anchored" data-anchor-id="fit-models-across-all-configurations">Fit models across all configurations</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(<span class="fu">str_c</span>(<span class="st">"~/Desktop/internship/moodivate/results_"</span>,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                      cv_resample_type, <span class="st">".csv"</span>))) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">str_c</span>(<span class="st">"~/Desktop/internship/moodivate/results_"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                      cv_resample_type, <span class="st">".csv"</span>),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">show_col_types =</span> F)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(configs<span class="sc">$</span>config_num) <span class="sc">|&gt;</span> </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(\(config_current) <span class="fu">fit_eval</span>(config_current, configs, </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                                 d, splits)) <span class="sc">|&gt;</span> </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list_rbind</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">new_config_num =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.))</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="glimpse-results" class="level3">
<h3 class="anchored" data-anchor-id="glimpse-results">Glimpse results</h3>
<p>This results file contains the information from the configuration grid, with model performance metrics appended to each row (i.e., model configuration). The grid has now been expanded to include each individual value for <code>hp2</code> (lambda/penalty) that was considered within <code>tune_models()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 33,000
Columns: 12
$ config_num     &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ split_num      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ feature_set    &lt;chr&gt; "thru_wk2", "thru_wk2", "thru_wk2", "thru_wk2", "thru_w…
$ hp1            &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ hp2            &lt;dbl&gt; 0.0003354626, 0.0003711182, 0.0004105636, 0.0004542015,…
$ accuracy       &lt;dbl&gt; 0.6571429, 0.6571429, 0.6571429, 0.6571429, 0.6571429, …
$ sens           &lt;dbl&gt; 0.6470588, 0.6470588, 0.6470588, 0.6470588, 0.6470588, …
$ spec           &lt;dbl&gt; 0.6666667, 0.6666667, 0.6666667, 0.6666667, 0.6666667, …
$ ppv            &lt;dbl&gt; 0.6470588, 0.6470588, 0.6470588, 0.6470588, 0.6470588, …
$ npv            &lt;dbl&gt; 0.6666667, 0.6666667, 0.6666667, 0.6666667, 0.6666667, …
$ roc_auc        &lt;dbl&gt; 0.6732026, 0.6732026, 0.6732026, 0.6732026, 0.6732026, …
$ new_config_num &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, …</code></pre>
</div>
</div>
<p>Save results</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">str_c</span>(<span class="st">"~/Desktop/internship/moodivate/results_"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                  cv_resample_type, <span class="st">".csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="select-final-model-configurations" class="level2">
<h2 class="anchored" data-anchor-id="select-final-model-configurations">Select final model configurations</h2>
<p>We now use average performance across the 10 held-out folds to select the best model configuration. As a reminder, performance metrics are being used <em>only</em> for selection and <em>not</em> for model evaluation. Evaluation was completed in the outer loop of nested cross-validation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="ot">&lt;-</span> results <span class="sc">|&gt;</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(feature_set, hp1, hp2) <span class="sc">|&gt;</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">c</span>(accuracy, roc_auc,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                     sens, spec, ppv, npv),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                   median),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_jobs =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(n_jobs) <span class="sc">|&gt;</span> </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(roc_auc)) <span class="sc">|&gt;</span> </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(metrics_avg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 3,300
Columns: 10
$ n_jobs      &lt;int&gt; 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10…
$ feature_set &lt;chr&gt; "thru_wk4", "thru_wk4", "thru_wk4", "thru_wk4", "thru_wk4"…
$ hp1         &lt;dbl&gt; 0.8, 0.0, 1.0, 0.0, 0.9, 1.0, 0.8, 0.0, 1.0, 0.0, 0.0, 0.0…
$ hp2         &lt;dbl&gt; 0.007683448, 0.086774329, 0.005674816, 0.070901432, 0.0069…
$ accuracy    &lt;dbl&gt; 0.4924242, 0.4777184, 0.4924242, 0.4777184, 0.4924242, 0.5…
$ roc_auc     &lt;dbl&gt; 0.5519031, 0.5501730, 0.5485510, 0.5484429, 0.5484429, 0.5…
$ sens        &lt;dbl&gt; 0.5312500, 0.5147059, 0.5147059, 0.4852941, 0.5312500, 0.5…
$ spec        &lt;dbl&gt; 0.5718954, 0.5294118, 0.5718954, 0.5424837, 0.5718954, 0.5…
$ ppv         &lt;dbl&gt; 0.4852941, 0.4686275, 0.4852941, 0.4686275, 0.4852941, 0.5…
$ npv         &lt;dbl&gt; 0.5000000, 0.4868421, 0.5000000, 0.4868421, 0.5000000, 0.5…</code></pre>
</div>
</div>
<p>Select best model configuration for each feature set (through week 2 / through week 3 / through week 4).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>best_config_thru_wk2 <span class="ot">&lt;-</span> metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feature_set <span class="sc">==</span> <span class="st">"thru_wk2"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  n_jobs feature_set   hp1    hp2 accuracy roc_auc  sens  spec   ppv   npv
   &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     10 thru_wk2        1 0.0524    0.507   0.531 0.324 0.618   0.5 0.511</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>best_config_thru_wk3 <span class="ot">&lt;-</span> metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feature_set <span class="sc">==</span> <span class="st">"thru_wk3"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  n_jobs feature_set   hp1    hp2 accuracy roc_auc  sens  spec   ppv   npv
   &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     10 thru_wk3      0.9 0.0115    0.485   0.537 0.471 0.559 0.471   0.5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>best_config_thru_wk4 <span class="ot">&lt;-</span> metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feature_set <span class="sc">==</span> <span class="st">"thru_wk4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 10
  n_jobs feature_set   hp1     hp2 accuracy roc_auc  sens  spec   ppv   npv
   &lt;int&gt; &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     10 thru_wk4      0.8 0.00768    0.492   0.552 0.531 0.572 0.485   0.5</code></pre>
</div>
</div>
<p>Save out best configurations for each feature set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>best_config_thru_wk2 <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">str_c</span>(<span class="st">"~/Desktop/internship/moodivate/best_config_thru_wk2.csv"</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>best_config_thru_wk3 <span class="sc">|&gt;</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">str_c</span>(<span class="st">"~/Desktop/internship/moodivate/best_config_thru_wk3.csv"</span>))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>best_config_thru_wk4 <span class="sc">|&gt;</span> </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">str_c</span>(<span class="st">"~/Desktop/internship/moodivate/best_config_thru_wk4.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fit-final-model" class="level2">
<h2 class="anchored" data-anchor-id="fit-final-model">Fit final model</h2>
<p>Ultimately, we will fit only one final model after having decided which feature set to favor (based on a performance vs.&nbsp;time-to-collect-data trade-off). This will be decided based on performance in the outer loop of nested cross-validation, <em>not</em> based on performance here in the final fitting stages.</p>
<p>Set best model configuration (selected feature set)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>best_config <span class="ot">&lt;-</span> best_config_thru_wk4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fit final model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>rec <span class="ot">&lt;-</span> <span class="fu">build_recipe</span>(<span class="at">d =</span> d, <span class="at">config =</span> best_config)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>rec_prepped_full <span class="ot">&lt;-</span> rec <span class="sc">|&gt;</span> </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(<span class="at">training =</span> d, <span class="at">strings_as_factors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>feat_all <span class="ot">&lt;-</span> rec_prepped_full <span class="sc">|&gt;</span> </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>penalty_weights <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">ncol</span>(feat_all) <span class="sc">-</span> <span class="dv">2</span>))</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>model_best_full <span class="ot">&lt;-</span> <span class="fu">fit_best_model</span>(<span class="at">best_model =</span> best_config, </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">feat =</span> feat_all, </span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">ml_mode =</span> ml_mode,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">algorithm =</span> algorithm,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">penalty_weights =</span> penalty_weights)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="model-coefficients" class="level3">
<h3 class="anchored" data-anchor-id="model-coefficients">Model coefficients</h3>
<p><strong>NOTE</strong>: Coefficients are naturally inverted (i.e., positive class [“non-responder”] treated as first [vs.&nbsp;second] class). Here, we multiply coefficients by -1 to align the direction of coefficients with the rest of our analyses. Once flipped (i.e., as they appear below)…</p>
<p>A <em>positive coefficient</em> indicates that increases in the feature <em>increase</em> the likelihood of being a non-responder.</p>
<p>A <em>negative coefficient</em> indicates that increases in the feature <em>decrease</em> the likelihood of being a non-responder (i.e., increase the likelihood of responding).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>model_tidy <span class="ot">&lt;-</span> <span class="fu">tidy</span>(model_best_full)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>model_tidy <span class="sc">|&gt;</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="st">"~/Desktop/internship/moodivate/model_best_tidy.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Table of all “retained” features (i.e., features whose parameter estimates were non-zero; parameter estimates of 0 indicate removal from the model via LASSO selection).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>retained_vars <span class="ot">&lt;-</span> model_tidy <span class="sc">|&gt;</span> </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">estimate =</span> estimate <span class="sc">*</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(estimate) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">|&gt;</span> </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>penalty) <span class="sc">|&gt;</span> </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(estimate)))</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(retained_vars, <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">badges_earned_wk3</td>
<td style="text-align: right;">0.3488</td>
</tr>
<tr class="even">
<td style="text-align: left;">add_activity_wk3</td>
<td style="text-align: right;">0.2509</td>
</tr>
<tr class="odd">
<td style="text-align: left;">badges_earned_wk4</td>
<td style="text-align: right;">-0.2277</td>
</tr>
<tr class="even">
<td style="text-align: left;">phq8_comp_wk4</td>
<td style="text-align: right;">0.1808</td>
</tr>
<tr class="odd">
<td style="text-align: left;">phq8_comp_wk3</td>
<td style="text-align: right;">-0.1702</td>
</tr>
<tr class="even">
<td style="text-align: left;">average_session_time_wk2</td>
<td style="text-align: right;">0.1698</td>
</tr>
<tr class="odd">
<td style="text-align: left;">session_count_wk3</td>
<td style="text-align: right;">-0.1578</td>
</tr>
<tr class="even">
<td style="text-align: left;">total_time_wk1</td>
<td style="text-align: right;">-0.1504</td>
</tr>
<tr class="odd">
<td style="text-align: left;">total_time_wk2</td>
<td style="text-align: right;">0.1453</td>
</tr>
<tr class="even">
<td style="text-align: left;">bdi_baseline</td>
<td style="text-align: right;">-0.1446</td>
</tr>
<tr class="odd">
<td style="text-align: left;">badges_earned_wk1</td>
<td style="text-align: right;">-0.1440</td>
</tr>
<tr class="even">
<td style="text-align: left;">completed_activities_wk2</td>
<td style="text-align: right;">-0.1421</td>
</tr>
<tr class="odd">
<td style="text-align: left;">add_goal_wk1</td>
<td style="text-align: right;">0.1339</td>
</tr>
<tr class="even">
<td style="text-align: left;">completed_activities_wk4</td>
<td style="text-align: right;">-0.1086</td>
</tr>
<tr class="odd">
<td style="text-align: left;">scheduled_activities_wk3</td>
<td style="text-align: right;">0.0922</td>
</tr>
<tr class="even">
<td style="text-align: left;">add_goal_wk4</td>
<td style="text-align: right;">-0.0898</td>
</tr>
<tr class="odd">
<td style="text-align: left;">session_count_wk4</td>
<td style="text-align: right;">-0.0585</td>
</tr>
<tr class="even">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-0.0498</td>
</tr>
<tr class="odd">
<td style="text-align: left;">completed_activities_wk1</td>
<td style="text-align: right;">-0.0483</td>
</tr>
<tr class="even">
<td style="text-align: left;">add_goal_wk2</td>
<td style="text-align: right;">0.0339</td>
</tr>
<tr class="odd">
<td style="text-align: left;">add_activity_wk2</td>
<td style="text-align: right;">-0.0265</td>
</tr>
<tr class="even">
<td style="text-align: left;">average_session_time_wk1</td>
<td style="text-align: right;">-0.0226</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mood_days_wk3</td>
<td style="text-align: right;">0.0206</td>
</tr>
<tr class="even">
<td style="text-align: left;">average_session_time_wk3</td>
<td style="text-align: right;">0.0202</td>
</tr>
<tr class="odd">
<td style="text-align: left;">badges_earned_wk2</td>
<td style="text-align: right;">-0.0171</td>
</tr>
<tr class="even">
<td style="text-align: left;">phq8_comp_wk2</td>
<td style="text-align: right;">-0.0089</td>
</tr>
<tr class="odd">
<td style="text-align: left;">average_session_time_wk4</td>
<td style="text-align: right;">-0.0034</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can also look at groupings of retained features by…</p>
<p><strong>Feature type</strong></p>
<p>Of note, <code>bdi_baseline</code> and <code>(Intercept)</code> can only have one feature as they do not repeat across weeks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>ret_vars_group <span class="ot">&lt;-</span> retained_vars <span class="sc">|&gt;</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(term, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"feature_type"</span>, <span class="st">"feature_week"</span>), </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">sep =</span> <span class="st">"_(?=wk</span><span class="sc">\\</span><span class="st">d+)"</span>, <span class="at">remove =</span> <span class="cn">FALSE</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="st">"right"</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>ret_vars_group <span class="sc">|&gt;</span> </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(feature_type, estimate) <span class="sc">|&gt;</span> </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feature_type =</span> <span class="fu">factor</span>(feature_type)) <span class="sc">|&gt;</span> </span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feature_type =</span> <span class="fu">fct_infreq</span>(feature_type)) <span class="sc">|&gt;</span> </span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> feature_type, <span class="at">fill =</span> feature_type)) <span class="sc">+</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_fit_select_final_model_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Feature week</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>ret_vars_group <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(feature_week, estimate) <span class="sc">|&gt;</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(feature_week)) <span class="sc">|&gt;</span> </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feature_week =</span> <span class="fu">factor</span>(feature_week,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                               <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"wk1"</span>, <span class="st">"wk2"</span>, <span class="st">"wk3"</span>, <span class="st">"wk4"</span>),</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Week 1"</span>, <span class="st">"Week 2"</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>                                          <span class="st">"Week 3"</span>, <span class="st">"Week 4"</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> feature_week, <span class="at">fill =</span> feature_week)) <span class="sc">+</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>() <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="04_fit_select_final_model_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>