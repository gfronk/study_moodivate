<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Gaylen Fronk">

<title>Analysis Workflow Step 2: Inner Loop Model Selection</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="02_eval_inner_files/libs/clipboard/clipboard.min.js"></script>
<script src="02_eval_inner_files/libs/quarto-html/quarto.js"></script>
<script src="02_eval_inner_files/libs/quarto-html/popper.min.js"></script>
<script src="02_eval_inner_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="02_eval_inner_files/libs/quarto-html/anchor.min.js"></script>
<link href="02_eval_inner_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="02_eval_inner_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="02_eval_inner_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="02_eval_inner_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="02_eval_inner_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Analysis Workflow Step 2: Inner Loop Model Selection</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Gaylen Fronk </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>Load libraries</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Source functions file</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"fun_moodivate.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This functions file (fun_moodivate.R) contains many functions that are used throughout the Moodivate project analysis scripts. Functions split data, fit and evaluate models, and provide helper functionality for the modeling process. See all annotated code building functions within fun_moodivate.R.</p>
</section>
<section id="read-in-data" class="level2">
<h2 class="anchored" data-anchor-id="read-in-data">Read in data</h2>
<p>Read in results file (“results.csv”) created in 01_fit_inner.qmd. This file contains one row per model configuration (unique combination of model tuning parameters) for each held-out fold. Each row contains the model configuration information (outer split number, inner split number, hp1 [alpha/mixture], and hp2 [lambda/penalty]). Each row also contains performance metrics for the model fit in the held-in data and evaluated in the indicated validation set (held-out fold from inner loop).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"results.csv"</span>, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>Rows: 330,000
Columns: 12
$ config_num      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ outer_split_num &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ inner_split_num &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ hp1             &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ hp2             &lt;dbl&gt; 0.0003354626, 0.0003711182, 0.0004105636, 0.0004542015…
$ accuracy        &lt;dbl&gt; 0.516129, 0.516129, 0.516129, 0.516129, 0.516129, 0.51…
$ sens            &lt;dbl&gt; 0.5333333, 0.5333333, 0.5333333, 0.5333333, 0.5333333,…
$ spec            &lt;dbl&gt; 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5,…
$ ppv             &lt;dbl&gt; 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5,…
$ npv             &lt;dbl&gt; 0.5333333, 0.5333333, 0.5333333, 0.5333333, 0.5333333,…
$ roc_auc         &lt;dbl&gt; 0.5333333, 0.5333333, 0.5333333, 0.5333333, 0.5333333,…
$ new_config_num  &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,…</code></pre>
</div>
</div>
</section>
<section id="process-metrics" class="level2">
<h2 class="anchored" data-anchor-id="process-metrics">Process metrics</h2>
<p>Check for duplicates</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>[1] 330000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> results <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(outer_split_num, inner_split_num, hp1, hp2,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>[1] 330000</code></pre>
</div>
</div>
<p>No duplicates</p>
<p>Checks that breakdowns are as expected. Should be equal numbers of each value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> janitor<span class="sc">::</span><span class="fu">tabyl</span>(outer_split_num) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code> outer_split_num     n    percent
               1 11000 0.03333333
               2 11000 0.03333333
               3 11000 0.03333333
               4 11000 0.03333333
               5 11000 0.03333333
               6 11000 0.03333333
               7 11000 0.03333333
               8 11000 0.03333333
               9 11000 0.03333333
              10 11000 0.03333333
              11 11000 0.03333333
              12 11000 0.03333333
              13 11000 0.03333333
              14 11000 0.03333333
              15 11000 0.03333333
              16 11000 0.03333333
              17 11000 0.03333333
              18 11000 0.03333333
              19 11000 0.03333333
              20 11000 0.03333333
              21 11000 0.03333333
              22 11000 0.03333333
              23 11000 0.03333333
              24 11000 0.03333333
              25 11000 0.03333333
              26 11000 0.03333333
              27 11000 0.03333333
              28 11000 0.03333333
              29 11000 0.03333333
              30 11000 0.03333333</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> janitor<span class="sc">::</span><span class="fu">tabyl</span>(inner_split_num) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code> inner_split_num     n percent
               1 33000     0.1
               2 33000     0.1
               3 33000     0.1
               4 33000     0.1
               5 33000     0.1
               6 33000     0.1
               7 33000     0.1
               8 33000     0.1
               9 33000     0.1
              10 33000     0.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> janitor<span class="sc">::</span><span class="fu">tabyl</span>(hp1) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code> hp1     n    percent
 0.0 30000 0.09090909
 0.1 30000 0.09090909
 0.2 30000 0.09090909
 0.3 30000 0.09090909
 0.4 30000 0.09090909
 0.5 30000 0.09090909
 0.6 30000 0.09090909
 0.7 30000 0.09090909
 0.8 30000 0.09090909
 0.9 30000 0.09090909
 1.0 30000 0.09090909</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> janitor<span class="sc">::</span><span class="fu">tabyl</span>(hp2) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>          hp2    n percent
 0.0003354626 3300    0.01
 0.0003711182 3300    0.01
 0.0004105636 3300    0.01
 0.0004542015 3300    0.01
 0.0005024775 3300    0.01
 0.0005558848 3300    0.01
 0.0006149686 3300    0.01
 0.0006803322 3300    0.01
 0.0007526433 3300    0.01
 0.0008326401 3300    0.01
 0.0009211396 3300    0.01
 0.0010190455 3300    0.01
 0.0011273576 3300    0.01
 0.0012471820 3300    0.01
 0.0013797422 3300    0.01
 0.0015263920 3300    0.01
 0.0016886289 3300    0.01
 0.0018681096 3300    0.01
 0.0020666669 3300    0.01
 0.0022863284 3300    0.01
 0.0025293372 3300    0.01
 0.0027981749 3300    0.01
 0.0030955869 3300    0.01
 0.0034246100 3300    0.01
 0.0037886043 3300    0.01
 0.0041912868 3300    0.01
 0.0046367695 3300    0.01
 0.0051296017 3300    0.01
 0.0056748158 3300    0.01
 0.0062779796 3300    0.01
 0.0069452523 3300    0.01
 0.0076834480 3300    0.01
 0.0085001050 3300    0.01
 0.0094035626 3300    0.01
 0.0104030467 3300    0.01
 0.0115087638 3300    0.01
 0.0127320052 3300    0.01
 0.0140852622 3300    0.01
 0.0155823540 3300    0.01
 0.0172385683 3300    0.01
 0.0190708181 3300    0.01
 0.0210978137 3300    0.01
 0.0233402543 3300    0.01
 0.0258210389 3300    0.01
 0.0285655008 3300    0.01
 0.0316016655 3300    0.01
 0.0349605375 3300    0.01
 0.0386764167 3300    0.01
 0.0427872486 3300    0.01
 0.0473350118 3300    0.01
 0.0523661468 3300    0.01
 0.0579320302 3300    0.01
 0.0640894992 3300    0.01
 0.0709014321 3300    0.01
 0.0784373905 3300    0.01
 0.0867743295 3300    0.01
 0.0959973835 3300    0.01
 0.1062007357 3300    0.01
 0.1174885800 3300    0.01
 0.1299761846 3300    0.01
 0.1437910695 3300    0.01
 0.1590743083 3300    0.01
 0.1759819691 3300    0.01
 0.1946867083 3300    0.01
 0.2153795334 3300    0.01
 0.2382717537 3300    0.01
 0.2635971381 3300    0.01
 0.2916143023 3300    0.01
 0.3226093497 3300    0.01
 0.3568987930 3300    0.01
 0.3948327864 3300    0.01
 0.4367987011 3300    0.01
 0.4832250812 3300    0.01
 0.5345860199 3300    0.01
 0.5914060006 3300    0.01
 0.6542652529 3300    0.01
 0.7238056780 3300    0.01
 0.8007374029 3300    0.01
 0.8858460329 3300    0.01
 0.9800006734 3300    0.01
 1.0841628049 3300    0.01
 1.1993961020 3300    0.01
 1.3268772946 3300    0.01
 1.4679081848 3300    0.01
 1.6239289404 3300    0.01
 1.7965328013 3300    0.01
 1.9874823497 3300    0.01
 2.1987275087 3300    0.01
 2.4324254543 3300    0.01
 2.6909626442 3300    0.01
 2.9769791875 3300    0.01
 3.2933958046 3300    0.01
 3.6434436530 3300    0.01
 4.0306973228 3300    0.01
 4.4591113395 3300    0.01
 4.9330605466 3300    0.01
 5.4573847799 3300    0.01
 6.0374382910 3300    0.01
 6.6791444232 3300    0.01
 7.3890560989 3300    0.01</code></pre>
</div>
</div>
</section>
<section id="median-metrics-across-inner-folds-for-model-configurations" class="level2">
<h2 class="anchored" data-anchor-id="median-metrics-across-inner-folds-for-model-configurations">Median metrics across inner folds for model configurations</h2>
<p>This process groups by <code>outer_split_number</code>, <code>hp1</code>, and <code>hp2</code> such that each group contains the 10 inner held-out folds per unique combination of outer split number and tuning parameters. The <code>summarize()</code> function then averages model performance metrics across the 10 held-out folds (i.e., validation sets). Validation set performance will be used for <strong>model selection</strong> in script 03_fit_eval_outer.qmd.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="ot">&lt;-</span> results <span class="sc">|&gt;</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(outer_split_num, hp1, hp2) <span class="sc">|&gt;</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">c</span>(accuracy, roc_auc,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                     sens, spec, ppv, npv),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                   median),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_jobs =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(n_jobs) <span class="sc">|&gt;</span> </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(roc_auc)) <span class="sc">|&gt;</span> </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="review" class="level3">
<h3 class="anchored" data-anchor-id="review">Review</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(metrics_avg<span class="sc">$</span>n_jobs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>[1] 10</code></pre>
</div>
</div>
<p>The <code>n_jobs</code> variable should always be 10 jobs (10 inner held-out folds per combination of outer split number and tuning parameters).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code># A tibble: 50 × 10
   n_jobs outer_split_num   hp1    hp2 accuracy roc_auc  sens  spec   ppv   npv
    &lt;int&gt;           &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1     10              10   0.1 0.437     0.532   0.627 0.267 0.75  0.523 0.532
 2     10              10   0.1 0.395     0.525   0.621 0.3   0.75  0.528 0.524
 3     10              10   0.1 0.357     0.548   0.619 0.3   0.75  0.563 0.548
 4     10              10   0.2 0.176     0.548   0.619 0.3   0.719 0.577 0.546
 5     10              12   0.8 0.0579    0.532   0.617 0.367 0.688 0.523 0.537
 6     10              12   0.9 0.0473    0.565   0.617 0.367 0.719 0.569 0.558
 7     10              10   0.2 0.159     0.548   0.615 0.3   0.719 0.558 0.546
 8     10              12   0.8 0.0524    0.565   0.615 0.367 0.719 0.569 0.558
 9     10              12   1   0.0428    0.565   0.615 0.367 0.719 0.569 0.558
10     10              12   0.1 0.264     0.565   0.615 0.4   0.719 0.569 0.558
11     10              12   0.3 0.159     0.581   0.615 0.4   0.75  0.6   0.571
12     10              12   0.5 0.0868    0.565   0.615 0.367 0.719 0.569 0.558
13     10              12   0.6 0.0709    0.565   0.615 0.367 0.719 0.569 0.558
14     10              12   0.7 0.0641    0.565   0.615 0.367 0.719 0.569 0.558
15     10              12   0.9 0.0524    0.548   0.615 0.367 0.719 0.55  0.548
16     10              12   1   0.0473    0.548   0.615 0.367 0.719 0.55  0.548
17     10              11   0.1 0.238     0.548   0.614 0.367 0.710 0.591 0.543
18     10              10   0.1 0.323     0.548   0.612 0.3   0.75  0.563 0.548
19     10              12   0.2 0.159     0.581   0.612 0.4   0.75  0.612 0.568
20     10              12   0.6 0.0784    0.548   0.612 0.4   0.719 0.55  0.548
21     10              12   0.7 0.0579    0.565   0.612 0.4   0.719 0.569 0.561
22     10              11   0.1 0.215     0.548   0.612 0.367 0.677 0.564 0.543
23     10              10   0.1 0.292     0.548   0.610 0.3   0.719 0.558 0.553
24     10              12   0.1 0.292     0.581   0.610 0.4   0.719 0.604 0.572
25     10              12   0.1 0.437     0.541   0.610 0.367 0.75  0.563 0.535
26     10              12   0.2 0.106     0.581   0.610 0.4   0.719 0.608 0.568
27     10              12   0.2 0.144     0.565   0.610 0.4   0.719 0.569 0.558
28     10              12   0.2 0.215     0.574   0.610 0.4   0.75  0.6   0.558
29     10              12   0.2 0.238     0.541   0.610 0.4   0.719 0.563 0.536
30     10              12   0.3 0.130     0.565   0.610 0.4   0.719 0.569 0.561
31     10              12   0.4 0.0960    0.565   0.610 0.4   0.719 0.569 0.561
32     10              12   0.4 0.106     0.565   0.610 0.367 0.719 0.569 0.558
33     10              12   0.4 0.117     0.581   0.610 0.4   0.75  0.6   0.571
34     10              11   0.1 0.357     0.525   0.610 0.267 0.710 0.528 0.524
35     10              11   0.1 0.176     0.558   0.609 0.367 0.677 0.564 0.551
36     10              11   0.1 0.195     0.558   0.609 0.367 0.677 0.564 0.551
37     10              10   0.2 0.144     0.548   0.608 0.333 0.719 0.558 0.546
38     10              12   0.1 0.357     0.565   0.608 0.4   0.75  0.577 0.562
39     10              12   0.2 0.0960    0.581   0.608 0.4   0.719 0.608 0.568
40     10              12   0.2 0.130     0.565   0.608 0.4   0.719 0.569 0.558
41     10              12   0.3 0.0784    0.581   0.608 0.4   0.719 0.6   0.565
42     10              12   0.3 0.117     0.565   0.608 0.4   0.719 0.569 0.561
43     10              12   0.5 0.0784    0.565   0.608 0.4   0.719 0.569 0.561
44     10              12   0.6 0.0473    0.581   0.608 0.4   0.719 0.577 0.568
45     10              12   0.6 0.0641    0.548   0.608 0.4   0.688 0.551 0.55 
46     10              12   0.6 0.0868    0.558   0.608 0.367 0.75  0.578 0.545
47     10              12   0.4 0.130     0.558   0.608 0.367 0.719 0.569 0.545
48     10              11   0.1 0.395     0.525   0.607 0.267 0.744 0.535 0.523
49     10              10   0.2 0.195     0.548   0.607 0.3   0.75  0.563 0.544
50     10              10   0.3 0.106     0.565   0.607 0.333 0.719 0.583 0.560</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(roc_auc) <span class="sc">|&gt;</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hist</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_eval_inner_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Save average metrics file</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(outer_split_num, hp1, hp2) <span class="sc">|&gt;</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(<span class="st">"metrics_inner_avg.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="plot-tuning-parameters" class="level2">
<h2 class="anchored" data-anchor-id="plot-tuning-parameters">Plot tuning parameters</h2>
<p>This plot shows performance as a function of alpha/mixture (<code>hp1</code>) and lambda/penalty (<code>hp2</code>). With shuffled data, there is no real pattern of performance as a function of tuning parameters, creating odd-looking output.</p>
<p>With real data, we will confirm that the plot captures a peak (i.e., local maximum) in performance (auROC) before continuing to outer loop model fitting and evaluation. If performance is increasing toward one end of the range for either tuning parameter, we will <strong>NOT</strong> yet proceed to fitting and evaluating models in the outer loop (in 03_fit_eval_outer.qmd). First, we will add model configurations that expand the range, run those additional configurations in the inner loop, and re-evaluate model performance as a function of tuning parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>plot_hp <span class="ot">&lt;-</span> metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">hp1 =</span> <span class="fu">factor</span>(hp1, <span class="at">ordered =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(hp2),</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y =</span> roc_auc,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">group =</span> hp1,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> hp1)) <span class="sc">+</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">"mixture (alpha)"</span>) <span class="sc">+</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Plotting performance by glmnet hyperparameters"</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"penalty (lambda)"</span>,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"auROC"</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>plot_hp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_eval_inner_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>