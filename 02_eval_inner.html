<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Gaylen Fronk">

<title>Analysis Workflow Step 2: Inner Loop Model Selection</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="02_eval_inner_files/libs/clipboard/clipboard.min.js"></script>
<script src="02_eval_inner_files/libs/quarto-html/quarto.js"></script>
<script src="02_eval_inner_files/libs/quarto-html/popper.min.js"></script>
<script src="02_eval_inner_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="02_eval_inner_files/libs/quarto-html/anchor.min.js"></script>
<link href="02_eval_inner_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="02_eval_inner_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="02_eval_inner_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="02_eval_inner_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="02_eval_inner_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Analysis Workflow Step 2: Inner Loop Model Selection</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Gaylen Fronk </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>Load libraries</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Source functions file</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"fun_moodivate.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This functions file (fun_moodivate.R) contains many functions that are used throughout the Moodivate project analysis scripts. Functions split data, fit and evaluate models, and provide helper functionality for the modeling process. See all annotated code building functions within fun_moodivate.R.</p>
</section>
<section id="read-in-data" class="level2">
<h2 class="anchored" data-anchor-id="read-in-data">Read in data</h2>
<p>Read in results file (“results.csv”) created in 01_fit_inner.qmd. This file contains one row per model configuration (unique combination of model tuning parameters and feature set) for each held-out fold. Each row contains the model configuration information (outer split number, inner split number, feature set, hp1 [alpha/mixture], and hp2 [lambda/penalty]). Each row also contains performance metrics for the model fit in the held-in data and evaluated in the indicated validation set (held-out fold from inner loop).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cv_resample_type <span class="ot">&lt;-</span> <span class="st">"nested"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>results_glmnet <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">str_c</span>(<span class="st">"~/Desktop/dahne_lab/moodivate/results_"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                      cv_resample_type, <span class="st">"_glmnet.csv"</span>), </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">algorithm =</span> <span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(algorithm, <span class="at">.before =</span> feature_set) <span class="sc">|&gt;</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>Rows: 1,534,500
Columns: 14
$ config_num      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ outer_split_num &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ inner_split_num &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ algorithm       &lt;chr&gt; "glmnet", "glmnet", "glmnet", "glmnet", "glmnet", "glm…
$ feature_set     &lt;chr&gt; "thru_wk2", "thru_wk2", "thru_wk2", "thru_wk2", "thru_…
$ hp1             &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ hp2             &lt;dbl&gt; 0.000335463, 0.000371118, 0.000410564, 0.000454201, 0.…
$ accuracy        &lt;dbl&gt; 0.6774194, 0.6774194, 0.6774194, 0.6774194, 0.6774194,…
$ sens            &lt;dbl&gt; 0.6666667, 0.6666667, 0.6666667, 0.6666667, 0.6666667,…
$ spec            &lt;dbl&gt; 0.6875, 0.6875, 0.6875, 0.6875, 0.6875, 0.6875, 0.6875…
$ ppv             &lt;dbl&gt; 0.6666667, 0.6666667, 0.6666667, 0.6666667, 0.6666667,…
$ npv             &lt;dbl&gt; 0.6875, 0.6875, 0.6875, 0.6875, 0.6875, 0.6875, 0.6875…
$ roc_auc         &lt;dbl&gt; 0.5875, 0.5875, 0.5875, 0.5875, 0.5875, 0.5875, 0.5875…
$ new_config_num  &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>results_glm <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">str_c</span>(<span class="st">"~/Desktop/dahne_lab/moodivate/results_"</span>,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                      cv_resample_type, <span class="st">"_glm.csv"</span>), </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>Rows: 3,900
Columns: 15
$ config_num      &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,…
$ outer_split_num &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ inner_split_num &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, …
$ algorithm       &lt;chr&gt; "glm", "glm", "glm", "glm", "glm", "glm", "glm", "glm"…
$ feature_set     &lt;chr&gt; "thru_wk2", "thru_wk3", "thru_wk4", "sess_count", "tot…
$ hp1             &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
$ hp2             &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…
$ sens            &lt;dbl&gt; 0.6000000, 0.6000000, 0.6000000, 0.7333333, 0.6000000,…
$ spec            &lt;dbl&gt; 0.6250, 0.5000, 0.4375, 0.7500, 0.7500, 0.8125, 0.7500…
$ ppv             &lt;dbl&gt; 0.6000000, 0.5294118, 0.5000000, 0.7333333, 0.6923077,…
$ npv             &lt;dbl&gt; 0.6250000, 0.5714286, 0.5384615, 0.7500000, 0.6666667,…
$ accuracy        &lt;dbl&gt; 0.6129032, 0.5483871, 0.5161290, 0.7419355, 0.6774194,…
$ bal_accuracy    &lt;dbl&gt; 0.6125000, 0.5500000, 0.5187500, 0.7416667, 0.6750000,…
$ roc_auc         &lt;dbl&gt; 0.5666667, 0.5416667, 0.5250000, 0.7708333, 0.7458333,…
$ new_config_num  &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results_glmnet, results_glm) <span class="sc">|&gt;</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(outer_split_num, inner_split_num)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>Rows: 1,538,400
Columns: 15
$ config_num      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ outer_split_num &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ inner_split_num &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, …
$ algorithm       &lt;chr&gt; "glmnet", "glmnet", "glmnet", "glmnet", "glmnet", "glm…
$ feature_set     &lt;chr&gt; "thru_wk2", "thru_wk2", "thru_wk2", "thru_wk2", "thru_…
$ hp1             &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ hp2             &lt;dbl&gt; 0.000335463, 0.000371118, 0.000410564, 0.000454201, 0.…
$ accuracy        &lt;dbl&gt; 0.6774194, 0.6774194, 0.6774194, 0.6774194, 0.6774194,…
$ sens            &lt;dbl&gt; 0.6666667, 0.6666667, 0.6666667, 0.6666667, 0.6666667,…
$ spec            &lt;dbl&gt; 0.6875, 0.6875, 0.6875, 0.6875, 0.6875, 0.6875, 0.6875…
$ ppv             &lt;dbl&gt; 0.6666667, 0.6666667, 0.6666667, 0.6666667, 0.6666667,…
$ npv             &lt;dbl&gt; 0.6875, 0.6875, 0.6875, 0.6875, 0.6875, 0.6875, 0.6875…
$ roc_auc         &lt;dbl&gt; 0.5875, 0.5875, 0.5875, 0.5875, 0.5875, 0.5875, 0.5875…
$ new_config_num  &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,…
$ bal_accuracy    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">str_c</span>(<span class="st">"~/Desktop/dahne_lab/moodivate/results_"</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                      cv_resample_type, <span class="st">"_all.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="process-metrics" class="level2">
<h2 class="anchored" data-anchor-id="process-metrics">Process metrics</h2>
<p>Check for duplicates</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>[1] 1538400</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> results <span class="sc">|&gt;</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(outer_split_num, inner_split_num, feature_set, hp1, hp2,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">.keep_all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>[1] 1340400</code></pre>
</div>
</div>
<p>Some duplicates got made when I added hp2 values for glmnet algorithms.</p>
<p>Checks that breakdowns are as expected. Should be equal numbers of each value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> janitor<span class="sc">::</span><span class="fu">tabyl</span>(outer_split_num) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code> outer_split_num     n    percent
               1 44680 0.03333333
               2 44680 0.03333333
               3 44680 0.03333333
               4 44680 0.03333333
               5 44680 0.03333333
               6 44680 0.03333333
               7 44680 0.03333333
               8 44680 0.03333333
               9 44680 0.03333333
              10 44680 0.03333333
              11 44680 0.03333333
              12 44680 0.03333333
              13 44680 0.03333333
              14 44680 0.03333333
              15 44680 0.03333333
              16 44680 0.03333333
              17 44680 0.03333333
              18 44680 0.03333333
              19 44680 0.03333333
              20 44680 0.03333333
              21 44680 0.03333333
              22 44680 0.03333333
              23 44680 0.03333333
              24 44680 0.03333333
              25 44680 0.03333333
              26 44680 0.03333333
              27 44680 0.03333333
              28 44680 0.03333333
              29 44680 0.03333333
              30 44680 0.03333333</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> janitor<span class="sc">::</span><span class="fu">tabyl</span>(inner_split_num) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code> inner_split_num      n percent
               1 134040     0.1
               2 134040     0.1
               3 134040     0.1
               4 134040     0.1
               5 134040     0.1
               6 134040     0.1
               7 134040     0.1
               8 134040     0.1
               9 134040     0.1
              10 134040     0.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> janitor<span class="sc">::</span><span class="fu">tabyl</span>(hp1) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code> hp1      n     percent valid_percent
 0.0 121500 0.090644584    0.09090909
 0.1 121500 0.090644584    0.09090909
 0.2 121500 0.090644584    0.09090909
 0.3  90000 0.067144136    0.06734007
 0.3  31500 0.023500448    0.02356902
 0.4 121500 0.090644584    0.09090909
 0.5 121500 0.090644584    0.09090909
 0.6 121500 0.090644584    0.09090909
 0.7  90000 0.067144136    0.06734007
 0.7  31500 0.023500448    0.02356902
 0.8 121500 0.090644584    0.09090909
 0.9 121500 0.090644584    0.09090909
 1.0 121500 0.090644584    0.09090909
  NA   3900 0.002909579            NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> janitor<span class="sc">::</span><span class="fu">tabyl</span>(hp2) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>          hp2    n     percent valid_percent
 3.354630e-04 9900 0.007385855   0.007407407
 3.711180e-04 9900 0.007385855   0.007407407
 4.105640e-04 9900 0.007385855   0.007407407
 4.542010e-04 9900 0.007385855   0.007407407
 5.024780e-04 9900 0.007385855   0.007407407
 5.558850e-04 9900 0.007385855   0.007407407
 6.149690e-04 9900 0.007385855   0.007407407
 6.803320e-04 9900 0.007385855   0.007407407
 7.526430e-04 9900 0.007385855   0.007407407
 8.326400e-04 9900 0.007385855   0.007407407
 9.211400e-04 9900 0.007385855   0.007407407
 1.019045e-03 9900 0.007385855   0.007407407
 1.127358e-03 9900 0.007385855   0.007407407
 1.247182e-03 9900 0.007385855   0.007407407
 1.379742e-03 9900 0.007385855   0.007407407
 1.526392e-03 9900 0.007385855   0.007407407
 1.688629e-03 9900 0.007385855   0.007407407
 1.868110e-03 9900 0.007385855   0.007407407
 2.066667e-03 9900 0.007385855   0.007407407
 2.286328e-03 9900 0.007385855   0.007407407
 2.529337e-03 9900 0.007385855   0.007407407
 2.798175e-03 9900 0.007385855   0.007407407
 3.095587e-03 9900 0.007385855   0.007407407
 3.424610e-03 9900 0.007385855   0.007407407
 3.788604e-03 9900 0.007385855   0.007407407
 4.191287e-03 9900 0.007385855   0.007407407
 4.636770e-03 9900 0.007385855   0.007407407
 5.129602e-03 9900 0.007385855   0.007407407
 5.674816e-03 9900 0.007385855   0.007407407
 6.277980e-03 9900 0.007385855   0.007407407
 6.945252e-03 9900 0.007385855   0.007407407
 7.683448e-03 9900 0.007385855   0.007407407
 8.500105e-03 9900 0.007385855   0.007407407
 9.403563e-03 9900 0.007385855   0.007407407
 1.040305e-02 9900 0.007385855   0.007407407
 1.150876e-02 9900 0.007385855   0.007407407
 1.273200e-02 9900 0.007385855   0.007407407
 1.408526e-02 9900 0.007385855   0.007407407
 1.558235e-02 9900 0.007385855   0.007407407
 1.723857e-02 9900 0.007385855   0.007407407
 1.907082e-02 9900 0.007385855   0.007407407
 2.109781e-02 9900 0.007385855   0.007407407
 2.334025e-02 9900 0.007385855   0.007407407
 2.582104e-02 9900 0.007385855   0.007407407
 2.856550e-02 9900 0.007385855   0.007407407
 3.160167e-02 9900 0.007385855   0.007407407
 3.496054e-02 9900 0.007385855   0.007407407
 3.867642e-02 9900 0.007385855   0.007407407
 4.278725e-02 9900 0.007385855   0.007407407
 4.733501e-02 9900 0.007385855   0.007407407
 5.236615e-02 9900 0.007385855   0.007407407
 5.793203e-02 9900 0.007385855   0.007407407
 6.408950e-02 9900 0.007385855   0.007407407
 7.090143e-02 9900 0.007385855   0.007407407
 7.843739e-02 9900 0.007385855   0.007407407
 8.677433e-02 9900 0.007385855   0.007407407
 9.599738e-02 9900 0.007385855   0.007407407
 1.062007e-01 9900 0.007385855   0.007407407
 1.174886e-01 9900 0.007385855   0.007407407
 1.299762e-01 9900 0.007385855   0.007407407
 1.437911e-01 9900 0.007385855   0.007407407
 1.590743e-01 9900 0.007385855   0.007407407
 1.759820e-01 9900 0.007385855   0.007407407
 1.946867e-01 9900 0.007385855   0.007407407
 2.153795e-01 9900 0.007385855   0.007407407
 2.382718e-01 9900 0.007385855   0.007407407
 2.635971e-01 9900 0.007385855   0.007407407
 2.916143e-01 9900 0.007385855   0.007407407
 3.226094e-01 9900 0.007385855   0.007407407
 3.568988e-01 9900 0.007385855   0.007407407
 3.948328e-01 9900 0.007385855   0.007407407
 4.367987e-01 9900 0.007385855   0.007407407
 4.832251e-01 9900 0.007385855   0.007407407
 5.345860e-01 9900 0.007385855   0.007407407
 5.914060e-01 9900 0.007385855   0.007407407
 6.542653e-01 9900 0.007385855   0.007407407
 7.238057e-01 9900 0.007385855   0.007407407
 8.007374e-01 9900 0.007385855   0.007407407
 8.858460e-01 9900 0.007385855   0.007407407
 9.800007e-01 9900 0.007385855   0.007407407
 1.084163e+00 9900 0.007385855   0.007407407
 1.199396e+00 9900 0.007385855   0.007407407
 1.326877e+00 9900 0.007385855   0.007407407
 1.467908e+00 9900 0.007385855   0.007407407
 1.623929e+00 9900 0.007385855   0.007407407
 1.796533e+00 9900 0.007385855   0.007407407
 1.987482e+00 9900 0.007385855   0.007407407
 2.198728e+00 9900 0.007385855   0.007407407
 2.432425e+00 9900 0.007385855   0.007407407
 2.690963e+00 9900 0.007385855   0.007407407
 2.976979e+00 9900 0.007385855   0.007407407
 3.293396e+00 9900 0.007385855   0.007407407
 3.643444e+00 9900 0.007385855   0.007407407
 4.030697e+00 9900 0.007385855   0.007407407
 4.459111e+00 9900 0.007385855   0.007407407
 4.933061e+00 9900 0.007385855   0.007407407
 5.457385e+00 9900 0.007385855   0.007407407
 6.037438e+00 9900 0.007385855   0.007407407
 6.679144e+00 9900 0.007385855   0.007407407
 7.389056e+00 9900 0.007385855   0.007407407
 8.166170e+00 9900 0.007385855   0.007407407
 9.025013e+00 9900 0.007385855   0.007407407
 9.974182e+00 9900 0.007385855   0.007407407
 1.102318e+01 9900 0.007385855   0.007407407
 1.218249e+01 9900 0.007385855   0.007407407
 1.346374e+01 9900 0.007385855   0.007407407
 1.487973e+01 9900 0.007385855   0.007407407
 1.644465e+01 9900 0.007385855   0.007407407
 1.817415e+01 9900 0.007385855   0.007407407
 2.008554e+01 9900 0.007385855   0.007407407
 2.219795e+01 9900 0.007385855   0.007407407
 2.453253e+01 9900 0.007385855   0.007407407
 2.711264e+01 9900 0.007385855   0.007407407
 2.996410e+01 9900 0.007385855   0.007407407
 3.311545e+01 9900 0.007385855   0.007407407
 3.659823e+01 9900 0.007385855   0.007407407
 4.044730e+01 9900 0.007385855   0.007407407
 4.470118e+01 9900 0.007385855   0.007407407
 4.940245e+01 9900 0.007385855   0.007407407
 5.459815e+01 9900 0.007385855   0.007407407
 6.034029e+01 9900 0.007385855   0.007407407
 6.668633e+01 9900 0.007385855   0.007407407
 7.369979e+01 9900 0.007385855   0.007407407
 8.145087e+01 9900 0.007385855   0.007407407
 9.001713e+01 9900 0.007385855   0.007407407
 9.948432e+01 9900 0.007385855   0.007407407
 1.099472e+02 9900 0.007385855   0.007407407
 1.215104e+02 9900 0.007385855   0.007407407
 1.342898e+02 9900 0.007385855   0.007407407
 1.484132e+02 9900 0.007385855   0.007407407
 1.640219e+02 9900 0.007385855   0.007407407
 1.812722e+02 9900 0.007385855   0.007407407
 2.003368e+02 9900 0.007385855   0.007407407
 2.214064e+02 9900 0.007385855   0.007407407
 2.446919e+02 9900 0.007385855   0.007407407
           NA 3900 0.002909579            NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> janitor<span class="sc">::</span><span class="fu">tabyl</span>(feature_set)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>  feature_set      n      percent
      add_act    300 0.0002238138
     add_goal    300 0.0002238138
       badges    300 0.0002238138
 complete_act    300 0.0002238138
    mood_days    300 0.0002238138
         phq8    300 0.0002238138
    sched_act    300 0.0002238138
   sess_count    300 0.0002238138
    sess_time    300 0.0002238138
     thru_wk2 445800 0.3325872874
     thru_wk3 445800 0.3325872874
     thru_wk4 445800 0.3325872874
   total_time    300 0.0002238138</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> janitor<span class="sc">::</span><span class="fu">tabyl</span>(algorithm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code> algorithm       n     percent
       glm    3900 0.002909579
    glmnet 1336500 0.997090421</code></pre>
</div>
</div>
<p>hp1 values are showing up a little weird here for some reason, but they aggregate together correctly.</p>
</section>
<section id="median-metrics-across-inner-folds-for-model-configurations" class="level2">
<h2 class="anchored" data-anchor-id="median-metrics-across-inner-folds-for-model-configurations">Median metrics across inner folds for model configurations</h2>
<p>This process groups by <code>outer_split_number</code>, <code>feature_set</code>, <code>hp1</code>, and <code>hp2</code> such that each group contains the 10 inner held-out folds per unique combination of outer split number, feature set, and tuning parameters. The <code>summarize()</code> function then averages model performance metrics across the 10 held-out folds (i.e., validation sets). Validation set performance will be used for <strong>model selection</strong> in script 03_fit_eval_outer.qmd.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="ot">&lt;-</span> results <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(outer_split_num, algorithm, feature_set, hp1, hp2) <span class="sc">|&gt;</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">c</span>(accuracy, roc_auc,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                     sens, spec, ppv, npv),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>                   median),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_jobs =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(n_jobs) <span class="sc">|&gt;</span> </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(roc_auc)) <span class="sc">|&gt;</span> </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="review" class="level3">
<h3 class="anchored" data-anchor-id="review">Review</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(metrics_avg<span class="sc">$</span>n_jobs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>[1] 10</code></pre>
</div>
</div>
<p>The <code>n_jobs</code> variable should always be 10 jobs (10 inner held-out folds per combination of outer split number, feature set, and tuning parameters).</p>
<p><strong>Performance: Through Week 2 Models</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feature_set <span class="sc">==</span> <span class="st">"thru_wk2"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>) <span class="sc">|&gt;</span> </span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(feature_set, algorithm, hp1, hp2, roc_auc) <span class="sc">|&gt;</span> </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code># A tibble: 50 × 5
   feature_set algorithm   hp1      hp2 roc_auc
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
 1 thru_wk2    glmnet      0.2   0.144    0.649
 2 thru_wk2    glmnet      0.3   0.0960   0.649
 3 thru_wk2    glmnet      0    54.6      0.649
 4 thru_wk2    glmnet      0    60.3      0.649
 5 thru_wk2    glmnet      0    66.7      0.649
 6 thru_wk2    glmnet      0    73.7      0.649
 7 thru_wk2    glmnet      0    81.5      0.649
 8 thru_wk2    glmnet      0    90.0      0.649
 9 thru_wk2    glmnet      0    99.5      0.649
10 thru_wk2    glmnet      0   110.       0.649
11 thru_wk2    glmnet      0   122.       0.649
12 thru_wk2    glmnet      0   134.       0.649
13 thru_wk2    glmnet      0   148.       0.649
14 thru_wk2    glmnet      0   164.       0.649
15 thru_wk2    glmnet      0   181.       0.649
16 thru_wk2    glmnet      0   200.       0.649
17 thru_wk2    glmnet      0   221.       0.649
18 thru_wk2    glmnet      0   245.       0.649
19 thru_wk2    glmnet      0.1   8.17     0.649
20 thru_wk2    glmnet      0.1   9.03     0.649
21 thru_wk2    glmnet      0.1   9.97     0.649
22 thru_wk2    glmnet      0.1  11.0      0.649
23 thru_wk2    glmnet      0.1  12.2      0.649
24 thru_wk2    glmnet      0.1  13.5      0.649
25 thru_wk2    glmnet      0.1  14.9      0.649
26 thru_wk2    glmnet      0.1  16.4      0.649
27 thru_wk2    glmnet      0.1  18.2      0.649
28 thru_wk2    glmnet      0.1  20.1      0.649
29 thru_wk2    glmnet      0.1  22.2      0.649
30 thru_wk2    glmnet      0.1  24.5      0.649
31 thru_wk2    glmnet      0.1  27.1      0.649
32 thru_wk2    glmnet      0.1  30.0      0.649
33 thru_wk2    glmnet      0.1  33.1      0.649
34 thru_wk2    glmnet      0.1  36.6      0.649
35 thru_wk2    glmnet      0.1  40.4      0.649
36 thru_wk2    glmnet      0.1  44.7      0.649
37 thru_wk2    glmnet      0.1  49.4      0.649
38 thru_wk2    glmnet      0.1  54.6      0.649
39 thru_wk2    glmnet      0.1  60.3      0.649
40 thru_wk2    glmnet      0.1  66.7      0.649
41 thru_wk2    glmnet      0.1  73.7      0.649
42 thru_wk2    glmnet      0.1  81.5      0.649
43 thru_wk2    glmnet      0.1  90.0      0.649
44 thru_wk2    glmnet      0.1  99.5      0.649
45 thru_wk2    glmnet      0.1 110.       0.649
46 thru_wk2    glmnet      0.1 122.       0.649
47 thru_wk2    glmnet      0.1 134.       0.649
48 thru_wk2    glmnet      0.1 148.       0.649
49 thru_wk2    glmnet      0.1 164.       0.649
50 thru_wk2    glmnet      0.1 181.       0.649</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feature_set <span class="sc">==</span> <span class="st">"thru_wk2"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(roc_auc) <span class="sc">|&gt;</span> </span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hist</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_eval_inner_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Performance: Through Week 3 Models</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feature_set <span class="sc">==</span> <span class="st">"thru_wk3"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(feature_set, algorithm, hp1, hp2, roc_auc) <span class="sc">|&gt;</span> </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>) <span class="sc">|&gt;</span> </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code># A tibble: 50 × 5
   feature_set algorithm   hp1    hp2 roc_auc
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
 1 thru_wk3    glmnet      0    54.6    0.649
 2 thru_wk3    glmnet      0    60.3    0.649
 3 thru_wk3    glmnet      0    66.7    0.649
 4 thru_wk3    glmnet      0    73.7    0.649
 5 thru_wk3    glmnet      0    81.5    0.649
 6 thru_wk3    glmnet      0    90.0    0.649
 7 thru_wk3    glmnet      0    99.5    0.649
 8 thru_wk3    glmnet      0   110.     0.649
 9 thru_wk3    glmnet      0   122.     0.649
10 thru_wk3    glmnet      0   134.     0.649
11 thru_wk3    glmnet      0   148.     0.649
12 thru_wk3    glmnet      0   164.     0.649
13 thru_wk3    glmnet      0   181.     0.649
14 thru_wk3    glmnet      0   200.     0.649
15 thru_wk3    glmnet      0   221.     0.649
16 thru_wk3    glmnet      0   245.     0.649
17 thru_wk3    glmnet      0.1   8.17   0.649
18 thru_wk3    glmnet      0.1   9.03   0.649
19 thru_wk3    glmnet      0.1   9.97   0.649
20 thru_wk3    glmnet      0.1  11.0    0.649
21 thru_wk3    glmnet      0.1  12.2    0.649
22 thru_wk3    glmnet      0.1  13.5    0.649
23 thru_wk3    glmnet      0.1  14.9    0.649
24 thru_wk3    glmnet      0.1  16.4    0.649
25 thru_wk3    glmnet      0.1  18.2    0.649
26 thru_wk3    glmnet      0.1  20.1    0.649
27 thru_wk3    glmnet      0.1  22.2    0.649
28 thru_wk3    glmnet      0.1  24.5    0.649
29 thru_wk3    glmnet      0.1  27.1    0.649
30 thru_wk3    glmnet      0.1  30.0    0.649
31 thru_wk3    glmnet      0.1  33.1    0.649
32 thru_wk3    glmnet      0.1  36.6    0.649
33 thru_wk3    glmnet      0.1  40.4    0.649
34 thru_wk3    glmnet      0.1  44.7    0.649
35 thru_wk3    glmnet      0.1  49.4    0.649
36 thru_wk3    glmnet      0.1  54.6    0.649
37 thru_wk3    glmnet      0.1  60.3    0.649
38 thru_wk3    glmnet      0.1  66.7    0.649
39 thru_wk3    glmnet      0.1  73.7    0.649
40 thru_wk3    glmnet      0.1  81.5    0.649
41 thru_wk3    glmnet      0.1  90.0    0.649
42 thru_wk3    glmnet      0.1  99.5    0.649
43 thru_wk3    glmnet      0.1 110.     0.649
44 thru_wk3    glmnet      0.1 122.     0.649
45 thru_wk3    glmnet      0.1 134.     0.649
46 thru_wk3    glmnet      0.1 148.     0.649
47 thru_wk3    glmnet      0.1 164.     0.649
48 thru_wk3    glmnet      0.1 181.     0.649
49 thru_wk3    glmnet      0.1 200.     0.649
50 thru_wk3    glmnet      0.1 221.     0.649</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feature_set <span class="sc">==</span> <span class="st">"thru_wk3"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(roc_auc) <span class="sc">|&gt;</span> </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hist</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_eval_inner_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Performance: Through Week 4 Models</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feature_set <span class="sc">==</span> <span class="st">"thru_wk4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(feature_set, algorithm, hp1, hp2, roc_auc) <span class="sc">|&gt;</span> </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code># A tibble: 50 × 5
   feature_set algorithm   hp1    hp2 roc_auc
   &lt;chr&gt;       &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
 1 thru_wk4    glmnet      0    54.6    0.649
 2 thru_wk4    glmnet      0    60.3    0.649
 3 thru_wk4    glmnet      0    66.7    0.649
 4 thru_wk4    glmnet      0    73.7    0.649
 5 thru_wk4    glmnet      0    81.5    0.649
 6 thru_wk4    glmnet      0    90.0    0.649
 7 thru_wk4    glmnet      0    99.5    0.649
 8 thru_wk4    glmnet      0   110.     0.649
 9 thru_wk4    glmnet      0   122.     0.649
10 thru_wk4    glmnet      0   134.     0.649
11 thru_wk4    glmnet      0   148.     0.649
12 thru_wk4    glmnet      0   164.     0.649
13 thru_wk4    glmnet      0   181.     0.649
14 thru_wk4    glmnet      0   200.     0.649
15 thru_wk4    glmnet      0   221.     0.649
16 thru_wk4    glmnet      0   245.     0.649
17 thru_wk4    glmnet      0.1   8.17   0.649
18 thru_wk4    glmnet      0.1   9.03   0.649
19 thru_wk4    glmnet      0.1   9.97   0.649
20 thru_wk4    glmnet      0.1  11.0    0.649
21 thru_wk4    glmnet      0.1  12.2    0.649
22 thru_wk4    glmnet      0.1  13.5    0.649
23 thru_wk4    glmnet      0.1  14.9    0.649
24 thru_wk4    glmnet      0.1  16.4    0.649
25 thru_wk4    glmnet      0.1  18.2    0.649
26 thru_wk4    glmnet      0.1  20.1    0.649
27 thru_wk4    glmnet      0.1  22.2    0.649
28 thru_wk4    glmnet      0.1  24.5    0.649
29 thru_wk4    glmnet      0.1  27.1    0.649
30 thru_wk4    glmnet      0.1  30.0    0.649
31 thru_wk4    glmnet      0.1  33.1    0.649
32 thru_wk4    glmnet      0.1  36.6    0.649
33 thru_wk4    glmnet      0.1  40.4    0.649
34 thru_wk4    glmnet      0.1  44.7    0.649
35 thru_wk4    glmnet      0.1  49.4    0.649
36 thru_wk4    glmnet      0.1  54.6    0.649
37 thru_wk4    glmnet      0.1  60.3    0.649
38 thru_wk4    glmnet      0.1  66.7    0.649
39 thru_wk4    glmnet      0.1  73.7    0.649
40 thru_wk4    glmnet      0.1  81.5    0.649
41 thru_wk4    glmnet      0.1  90.0    0.649
42 thru_wk4    glmnet      0.1  99.5    0.649
43 thru_wk4    glmnet      0.1 110.     0.649
44 thru_wk4    glmnet      0.1 122.     0.649
45 thru_wk4    glmnet      0.1 134.     0.649
46 thru_wk4    glmnet      0.1 148.     0.649
47 thru_wk4    glmnet      0.1 164.     0.649
48 thru_wk4    glmnet      0.1 181.     0.649
49 thru_wk4    glmnet      0.1 200.     0.649
50 thru_wk4    glmnet      0.1 221.     0.649</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(feature_set <span class="sc">==</span> <span class="st">"thru_wk4"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(roc_auc) <span class="sc">|&gt;</span> </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">hist</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_eval_inner_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>Performance: Single-Feature Group Models</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">str_detect</span>(feature_set, <span class="st">"thru_"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(feature_set, algorithm, roc_auc) <span class="sc">|&gt;</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>) <span class="sc">|&gt;</span> </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code># A tibble: 50 × 3
   feature_set  algorithm roc_auc
   &lt;chr&gt;        &lt;chr&gt;       &lt;dbl&gt;
 1 total_time   glm         0.671
 2 total_time   glm         0.665
 3 total_time   glm         0.660
 4 sess_count   glm         0.656
 5 phq8         glm         0.654
 6 total_time   glm         0.65 
 7 add_act      glm         0.646
 8 total_time   glm         0.646
 9 total_time   glm         0.646
10 sess_count   glm         0.643
11 add_act      glm         0.643
12 add_act      glm         0.643
13 sched_act    glm         0.640
14 mood_days    glm         0.640
15 total_time   glm         0.639
16 sess_count   glm         0.639
17 total_time   glm         0.638
18 total_time   glm         0.638
19 total_time   glm         0.638
20 sess_time    glm         0.637
21 add_goal     glm         0.637
22 total_time   glm         0.636
23 add_act      glm         0.636
24 phq8         glm         0.634
25 sess_count   glm         0.633
26 total_time   glm         0.633
27 sess_count   glm         0.633
28 total_time   glm         0.632
29 mood_days    glm         0.632
30 complete_act glm         0.631
31 add_goal     glm         0.631
32 total_time   glm         0.630
33 phq8         glm         0.630
34 sess_count   glm         0.630
35 total_time   glm         0.630
36 sess_time    glm         0.629
37 mood_days    glm         0.629
38 sess_time    glm         0.629
39 sess_time    glm         0.629
40 add_goal     glm         0.628
41 total_time   glm         0.628
42 sess_count   glm         0.627
43 sess_count   glm         0.627
44 total_time   glm         0.627
45 phq8         glm         0.626
46 complete_act glm         0.626
47 mood_days    glm         0.626
48 total_time   glm         0.625
49 add_act      glm         0.625
50 sched_act    glm         0.624</code></pre>
</div>
</div>
<p><strong>Performance: By Algorithm</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(algorithm) <span class="sc">|&gt;</span> </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">median_auc =</span> <span class="fu">median</span>(roc_auc),</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">min_auc =</span> <span class="fu">min</span>(roc_auc),</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">max_auc =</span> <span class="fu">max</span>(roc_auc))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code># A tibble: 2 × 4
  algorithm median_auc min_auc max_auc
  &lt;chr&gt;          &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1 glm            0.589   0.421   0.671
2 glmnet         0.597   0.431   0.649</code></pre>
</div>
</div>
<p><strong>Performance: Across Feature Sets</strong></p>
<p>Median performance across ALL configurations</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">median_auc =</span> <span class="fu">median</span>(roc_auc),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">min_auc =</span> <span class="fu">min</span>(roc_auc),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">max_auc =</span> <span class="fu">max</span>(roc_auc))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code># A tibble: 1 × 3
  median_auc min_auc max_auc
       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1      0.597   0.421   0.671</code></pre>
</div>
</div>
<p>Performance of best configurations</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">11397</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>configs_best <span class="ot">&lt;-</span> metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># negate hp1 so that we can prefer the max (hp1 closest to 0)</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inv_hp1 =</span> hp1 <span class="sc">*</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(outer_split_num) <span class="sc">|&gt;</span> </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select config w max roc_auc with lowest hp1 (highest inv_hp1)</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># keep remaining ties (i.e., same roc_auc and same hp1)</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> <span class="fu">tibble</span>(roc_auc, inv_hp1), <span class="at">with_ties =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(outer_split_num) <span class="sc">|&gt;</span> </span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># among remaining ties, randomly select single config </span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>inv_hp1) <span class="sc">|&gt;</span> </span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>configs_best <span class="sc">|&gt;</span> </span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(outer_split_num, algorithm, feature_set, hp1, hp2, roc_auc) <span class="sc">|&gt;</span> </span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code># A tibble: 30 × 6
   outer_split_num algorithm feature_set   hp1     hp2 roc_auc
             &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1               1 glm       total_time   NA   NA        0.65 
 2               2 glm       sess_time    NA   NA        0.629
 3               3 glm       mood_days    NA   NA        0.598
 4               4 glm       total_time   NA   NA        0.671
 5               5 glm       total_time   NA   NA        0.630
 6               6 glm       total_time   NA   NA        0.638
 7               7 glm       sess_count   NA   NA        0.627
 8               8 glm       total_time   NA   NA        0.665
 9               9 glm       total_time   NA   NA        0.609
10              10 glmnet    thru_wk3      0   54.6      0.643
11              11 glmnet    thru_wk2      0.1  0.159    0.648
12              12 glm       total_time   NA   NA        0.606
13              13 glmnet    thru_wk2      0   33.1      0.617
14              14 glm       total_time   NA   NA        0.625
15              15 glmnet    thru_wk2      0    1.62     0.648
16              16 glm       total_time   NA   NA        0.639
17              17 glm       total_time   NA   NA        0.660
18              18 glm       sess_count   NA   NA        0.639
19              19 glm       phq8         NA   NA        0.654
20              20 glm       total_time   NA   NA        0.627
21              21 glm       add_act      NA   NA        0.636
22              22 glm       total_time   NA   NA        0.633
23              23 glmnet    thru_wk4      0.6  0.0428   0.633
24              24 glmnet    thru_wk4      0.4  0.106    0.640
25              25 glm       total_time   NA   NA        0.624
26              26 glm       total_time   NA   NA        0.646
27              27 glmnet    thru_wk2      0.2  0.144    0.649
28              28 glm       total_time   NA   NA        0.628
29              29 glm       total_time   NA   NA        0.636
30              30 glm       total_time   NA   NA        0.623</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>configs_best <span class="sc">|&gt;</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> roc_auc)) <span class="sc">+</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_eval_inner_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>configs_best <span class="sc">|&gt;</span> </span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(roc_auc) <span class="sc">|&gt;</span> </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">median</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre style="max-height: 500px;"><code>[1] 0.6357465</code></pre>
</div>
</div>
<p>Save average metrics file (all feature sets)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>metrics_avg <span class="sc">|&gt;</span> </span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(outer_split_num, feature_set, hp1, hp2) <span class="sc">|&gt;</span> </span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(<span class="st">"~/Desktop/dahne_lab/moodivate/metrics_inner_avg.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="plot-tuning-parameters" class="level2">
<h2 class="anchored" data-anchor-id="plot-tuning-parameters">Plot tuning parameters</h2>
<p>This plot shows performance as a function of alpha/mixture (<code>hp1</code>) and lambda/penalty (<code>hp2</code>) separately for each <code>feature_set</code>. With shuffled data, there is no real pattern of performance as a function of tuning parameters, creating odd-looking output.</p>
<p>With real data, we will confirm that the plot captures a peak (i.e., local maximum) in performance (auROC) before continuing to outer loop model fitting and evaluation. If performance is increasing toward one end of the range for either tuning parameter, we will <strong>NOT</strong> yet proceed to fitting and evaluating models in the outer loop (in 03_fit_eval_outer.qmd). First, we will add model configurations that expand the range, run those additional configurations in the inner loop, and re-evaluate model performance as a function of tuning parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>metrics_plot <span class="ot">&lt;-</span> results <span class="sc">|&gt;</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(algorithm <span class="sc">==</span> <span class="st">"glmnet"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># don't group by outer_split_num, otherwise too many data points</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(feature_set, hp1, hp2) <span class="sc">|&gt;</span> </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">c</span>(accuracy, roc_auc,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>                     sens, spec, ppv, npv),</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>                   median),</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_jobs =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(n_jobs) <span class="sc">|&gt;</span> </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(roc_auc)) <span class="sc">|&gt;</span> </span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">feature_set =</span> <span class="fu">case_when</span>(</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    feature_set <span class="sc">==</span> <span class="st">"thru_wk2"</span> <span class="sc">~</span> <span class="st">"Weeks 1 &amp; 2"</span>,</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    feature_set <span class="sc">==</span> <span class="st">"thru_wk3"</span> <span class="sc">~</span> <span class="st">"Weeks 1 - 3"</span>,</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    feature_set <span class="sc">==</span> <span class="st">"thru_wk4"</span> <span class="sc">~</span> <span class="st">"Weeks 1 - 4"</span>,</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>feature_sets <span class="ot">&lt;-</span> <span class="fu">unique</span>(metrics_plot<span class="sc">$</span>feature_set) </span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> feature_sets) {</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>  results_i <span class="ot">&lt;-</span> metrics_plot <span class="sc">%&gt;%</span> </span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(feature_set <span class="sc">==</span> i)</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>  plot_title <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_c</span>(<span class="st">"Plotting glmnet hyperparameters for "</span>, </span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>                               i, <span class="st">" models"</span>)</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>  plot_i <span class="ot">&lt;-</span> results_i <span class="sc">%&gt;%</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hp1 =</span> <span class="fu">factor</span>(hp1, <span class="at">ordered =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(hp2), </span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>                         <span class="at">y =</span> roc_auc, </span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>                         <span class="at">group =</span> hp1, </span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>                         <span class="at">color =</span> hp1)) <span class="sc">+</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(hp1)) <span class="sc">+</span></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_discrete</span>(<span class="at">name =</span> <span class="st">"mixture (alpha)"</span>) <span class="sc">+</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> plot_title, <span class="at">x =</span> <span class="st">"penalty (lambda)"</span>, <span class="at">y =</span> <span class="st">"auROC"</span>)</span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_i)</span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_eval_inner_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_eval_inner_files/figure-html/unnamed-chunk-15-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_eval_inner_files/figure-html/unnamed-chunk-15-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plot-by-feature-set" class="level2">
<h2 class="anchored" data-anchor-id="plot-by-feature-set">Plot by feature set</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>metrics_plot <span class="ot">&lt;-</span> results <span class="sc">|&gt;</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># don't group by outer_split_num, otherwise too many data points</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(algorithm, feature_set, hp1, hp2) <span class="sc">|&gt;</span> </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(<span class="fu">c</span>(accuracy, roc_auc,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>                     sens, spec, ppv, npv),</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>                   median),</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_jobs =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(n_jobs) <span class="sc">|&gt;</span> </span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(roc_auc)) <span class="sc">|&gt;</span> </span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>metrics_plot <span class="ot">&lt;-</span> metrics_plot <span class="sc">|&gt;</span> </span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(feature_set) <span class="sc">|&gt;</span> </span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">med_roc =</span> <span class="fu">median</span>(roc_auc)) <span class="sc">|&gt;</span> </span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># larger feature sets</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>metrics_plot <span class="sc">|&gt;</span> </span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> feature_set,</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fill =</span> feature_set,</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y =</span> med_roc)) <span class="sc">+</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Performance by Feature Set"</span>,</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"auROC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_eval_inner_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simpler feature sets</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>